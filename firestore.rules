/**
 * @fileoverview Firestore Security Rules for the application.
 *
 * Core Philosophy:
 * This ruleset enforces a mixed security model. User profiles are owner-writable and publicly readable.
 * Top-level collections for Accounts, Contacts, Products, AccountProductNotes, and CallNotes are publicly readable, but writes are restricted.
 *
 * Data Structure:
 * - /users/{userId}: Stores user profile data, only writable by the owner (the user themselves).
 * - /accounts-db/{accountId}: Stores account data. Publicly readable.
 * - /contacts/{contactId}: Stores contact information. Publicly readable.
 * - /products/{productId}: Stores product catalog data. Publicly readable.
 * - /account-products/{accountProductId}: Stores account product notes. Publicly readable.
 * - /call-notes/{callNoteId}: Stores call notes. Publicly readable.
 *
 * Key Security Decisions:
 * - User profiles are only writable by the user themselves.
 * - Listing of users is not allowed.
 * - Top-level collections are publicly readable to allow for easy data access, but write operations are restricted to authenticated users.
 * - Data validation is relaxed for prototyping purposes, focusing on ownership and relational integrity.
 *
 * Denormalization for Authorization:
 *  - The current rules do not require denormalization. All authorization is based on the request's auth state.
 *
 * Structural Segregation:
 *  - The current rules do not require structural segregation.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Manages user profile data, ensuring only the user can modify their own profile.
     * @path /users/{userId}
     * @allow (create) - User with UID 'user123' can create their profile at /users/user123.
     * @allow (update) - User with UID 'user123' can update their profile at /users/user123.
     * @allow (get) - Any user can read a profile.
     * @deny (create) - User with UID 'user456' cannot create a profile at /users/user123.
     * @deny (update) - User with UID 'user456' cannot update the profile at /users/user123.
     * @principle Enforces document ownership for writes; allows public reads.
     */
    match /users/{userId} {
      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }

      allow get: if true;
      allow list: if false; // Listing users is not permitted.
      allow create: if isOwner(userId) && request.resource.data.id == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.id == resource.data.id;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Manages sales accounts. Publicly readable, writes restricted to authenticated users.
     * @path /accounts-db/{accountId}
     * @allow (get) - Any user can read an account.
     * @allow (list) - Any user can list accounts.
     * @deny (create) - Anonymous user cannot create an account.
     * @deny (update) - Anonymous user cannot update an account.
     * @deny (delete) - Anonymous user cannot delete an account.
     * @principle Allows public reads, restricts writes to authenticated users.
     */
    match /accounts-db/{accountId} {
      function isSignedIn() {
        return request.auth != null;
      }

      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn() && resource != null;
      allow delete: if isSignedIn() && resource != null;
    }

    /**
     * @description Manages contacts. Publicly readable, writes restricted to authenticated users.
     * @path /contacts/{contactId}
     * @allow (get) - Any user can read a contact.
     * @allow (list) - Any user can list contacts.
     * @deny (create) - Anonymous user cannot create a contact.
     * @deny (update) - Anonymous user cannot update a contact.
     * @deny (delete) - Anonymous user cannot delete a contact.
     * @principle Allows public reads, restricts writes to authenticated users.
     */
    match /contacts/{contactId} {
      function isSignedIn() {
        return request.auth != null;
      }

      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn() && resource != null;
      allow delete: if isSignedIn() && resource != null;
    }

    /**
     * @description Manages products. Publicly readable, writes restricted to authenticated users.
     * @path /products/{productId}
     * @allow (get) - Any user can read a product.
     * @allow (list) - Any user can list products.
     * @deny (create) - Anonymous user cannot create a product.
     * @deny (update) - Anonymous user cannot update a product.
     * @deny (delete) - Anonymous user cannot delete a product.
     * @principle Allows public reads, restricts writes to authenticated users.
     */
    match /products/{productId} {
      function isSignedIn() {
        return request.auth != null;
      }

      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn() && resource != null;
      allow delete: if isSignedIn() && resource != null;
    }

    /**
     * @description Manages account product notes. Publicly readable, writes restricted to authenticated users.
     * @path /account-products/{accountProductId}
     * @allow (get) - Any user can read an account product note.
     * @allow (list) - Any user can list account product notes.
     * @deny (create) - Anonymous user cannot create an account product note.
     * @deny (update) - Anonymous user cannot update an account product note.
     * @deny (delete) - Anonymous user cannot delete an account product note.
     * @principle Allows public reads, restricts writes to authenticated users.
     */
    match /account-products/{accountProductId} {
      function isSignedIn() {
        return request.auth != null;
      }

      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn() && resource != null;
      allow delete: if isSignedIn() && resource != null;
    }

    /**
     * @description Manages call notes. Publicly readable, writes restricted to authenticated users.
     * @path /call-notes/{callNoteId}
     * @allow (get) - Any user can read a call note.
     * @allow (list) - Any user can list call notes.
     * @deny (create) - Anonymous user cannot create a call note.
     * @deny (update) - Anonymous user cannot update a call note.
     * @deny (delete) - Anonymous user cannot delete a call note.
     * @principle Allows public reads, restricts writes to authenticated users.
     */
    match /call-notes/{callNoteId} {
      function isSignedIn() {
        return request.auth != null;
      }

      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn() && resource != null;
      allow delete: if isSignedIn() && resource != null;
    }
  }
}