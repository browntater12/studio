/**
 * @file Firestore Security Rules
 * @description This ruleset enforces a role-based access control model.
 *
 * Data Structure:
 * - /users/{userId}: Stores public user profiles, accessible only to the owning user.
 * - /accounts-db/{accountId}: Stores sales accounts, writeable by authorized users.
 * - /contacts/{contactId}: Stores contacts, writeable by authorized users.
 * - /account-products/{accountProductId}: Stores product notes linked to accounts, writeable by authorized users.
 * - /products/{productId}: Stores product information, writeable by authorized users.
 * - /call-notes/{callNoteId}: Stores call notes linked to accounts, writeable by authorized users.
 *
 * Key Security Decisions:
 * - User profiles are strictly private and owned by the respective user.
 * - All writes are protected by an authentication check (isSignedIn()).
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Manages user profile data, ensuring only the owning user can read or write.
     * @path /users/{userId}
     * @allow (create) - User with ID 'user123' creates their own profile.
     *    request.auth.uid == 'user123'
     *    request.resource.data.id == 'user123'
     * @allow (get, list) - User with ID 'user123' reads their own profile.
     *    request.auth.uid == 'user123'
     * @allow (update) - User with ID 'user123' updates their own profile.
     *    request.auth.uid == 'user123'
     * @allow (delete) - User with ID 'user123' deletes their own profile.
     *    request.auth.uid == 'user123'
     * @deny (create) - User with ID 'user123' attempts to create a profile for 'user456'.
     *    request.auth.uid == 'user123'
     *    request.resource.data.id == 'user456'
     * @deny (get, list) - User with ID 'user123' attempts to read profile of 'user456'.
     *    request.auth.uid == 'user123'
     * @deny (update) - User with ID 'user123' attempts to update profile of 'user456'.
     *    request.auth.uid == 'user123'
     * @deny (delete) - User with ID 'user123' attempts to delete profile of 'user456'.
     *    request.auth.uid == 'user123'
     * @principle Enforces document ownership and restricts access to a user's own data.
     */
    match /users/{userId} {
      allow get, list: if isOwner(userId);
      allow create: if isSignedIn() && isOwner(userId) && request.resource.data.id == userId;
      allow update: if isSignedIn() && isExistingOwner(userId) && request.resource.data.id == resource.data.id;
      allow delete: if isSignedIn() && isExistingOwner(userId);
    }

    /**
     * @description Manages sales accounts, allowing authorized users to create, read, update, and delete accounts.
     * @path /accounts-db/{accountId}
     * @allow (create) - Authenticated user creates a new account.
     *    request.auth.uid != null
     * @allow (get, list) - Any user can read accounts.
     * @allow (update) - Authenticated user updates an existing account.
     *    request.auth.uid != null
     * @allow (delete) - Authenticated user deletes an existing account.
     *    request.auth.uid != null
     * @deny (create) - Unauthenticated user tries to create an account.
     *    request.auth.uid == null
     * @deny (update) - Unauthenticated user tries to update an account.
     *    request.auth.uid == null
     * @deny (delete) - Unauthenticated user tries to delete an account.
     *    request.auth.uid == null
     */
    match /accounts-db/{accountId} {
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn() && resource != null;
      allow delete: if isSignedIn() && resource != null;
    }

    /**
     * @description Manages contacts, allowing authorized users to create, read, update, and delete contacts.
     * @path /contacts/{contactId}
     * @allow (create) - Authenticated user creates a new contact.
     *    request.auth.uid != null
     * @allow (get, list) - Any user can read contacts.
     * @allow (update) - Authenticated user updates an existing contact.
     *    request.auth.uid != null
     * @allow (delete) - Authenticated user deletes an existing contact.
     *    request.auth.uid != null
     * @deny (create) - Unauthenticated user tries to create a contact.
     *    request.auth.uid == null
     * @deny (update) - Unauthenticated user tries to update a contact.
     *    request.auth.uid == null
     * @deny (delete) - Unauthenticated user tries to delete a contact.
     *    request.auth.uid == null
     */
    match /contacts/{contactId} {
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn() && resource != null;
      allow delete: if isSignedIn() && resource != null;
    }

    /**
     * @description Manages product notes for specific accounts, allowing authorized users to create, read, update, and delete notes.
     * @path /account-products/{accountProductId}
     * @allow (create) - Authenticated user creates a new product note.
     *    request.auth.uid != null
     * @allow (get, list) - Any user can read product notes.
     * @allow (update) - Authenticated user updates an existing product note.
     *    request.auth.uid != null
     * @allow (delete) - Authenticated user deletes an existing product note.
     *    request.auth.uid != null
     * @deny (create) - Unauthenticated user tries to create a product note.
     *    request.auth.uid == null
     * @deny (update) - Unauthenticated user tries to update a product note.
     *    request.auth.uid == null
     * @deny (delete) - Unauthenticated user tries to delete a product note.
     *    request.auth.uid == null
     */
    match /account-products/{accountProductId} {
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn() && resource != null;
      allow delete: if isSignedIn() && resource != null;
    }

    /**
     * @description Manages product information, allowing authorized users to create, read, update, and delete products.
     * @path /products/{productId}
     * @allow (create) - Authenticated user creates a new product.
     *    request.auth.uid != null
     * @allow (get, list) - Any user can read products.
     * @allow (update) - Authenticated user updates an existing product.
     *    request.auth.uid != null
     * @allow (delete) - Authenticated user deletes an existing product.
     *    request.auth.uid != null
     * @deny (create) - Unauthenticated user tries to create a product.
     *    request.auth.uid == null
     * @deny (update) - Unauthenticated user tries to update a product.
     *    request.auth.uid == null
     * @deny (delete) - Unauthenticated user tries to delete a product.
     *    request.auth.uid == null
     */
    match /products/{productId} {
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn() && resource != null;
      allow delete: if isSignedIn() && resource != null;
    }

    /**
     * @description Manages call notes, allowing authorized users to create, read, update, and delete call notes.
     * @path /call-notes/{callNoteId}
     * @allow (create) - Authenticated user creates a new call note.
     *    request.auth.uid != null
     * @allow (get, list) - Any user can read call notes.
     * @allow (update) - Authenticated user updates an existing call note.
     *    request.auth.uid != null
     * @allow (delete) - Authenticated user deletes an existing call note.
     *    request.auth.uid != null
     * @deny (create) - Unauthenticated user tries to create a call note.
     *    request.auth.uid == null
     * @deny (update) - Unauthenticated user tries to update a call note.
     *    request.auth.uid == null
     * @deny (delete) - Unauthenticated user tries to delete a call note.
     *    request.auth.uid == null
     */
    match /call-notes/{callNoteId} {
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn() && resource != null;
      allow delete: if isSignedIn() && resource != null;
    }
  }

  function isSignedIn() {
    return request.auth != null;
  }

  function isOwner(userId) {
    return request.auth.uid == userId;
  }

  function isExistingOwner(userId) {
    return isOwner(userId) && resource != null;
  }
}