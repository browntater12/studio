/**
 * @fileoverview Firestore Security Rules for the application.
 *
 * Core Philosophy:
 * This ruleset enforces a combination of ownership-based access control and public read access where appropriate.
 * User profiles are private and only accessible to the owning user. Accounts, contacts, account products, and products are publicly readable, but only authorized users can create, update, or delete them.
 *
 * Data Structure:
 * - /users/{userId}: Stores user profile data.
 * - /accounts-db/{accountId}: Stores account data.
 * - /contacts/{contactId}: Stores contact data.
 * - /account-products/{accountProductId}: Stores account product notes.
 * - /products/{productId}: Stores product data.
 *
 * Key Security Decisions:
 * - User profiles are strictly private (owner-only access).
 * - Public read access is granted for the accounts-db, contacts, account-products, and products collections to facilitate data discovery and display.
 * - Writes to accounts-db, contacts, account-products, and products are currently open (TODO: Implement proper authorization).
 * - Listing of user documents is disallowed to protect user privacy.
 *
 * Denormalization for Authorization:
 *  N/A - Currently, write access to all collections is open, so no authorization checks are performed.  Once authorization is implemented, ownership or role-based access control will be denormalized onto the documents.
 *
 * Structural Segregation:
 * N/A - The application does not currently segregate data based on public vs. private access.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Manages user profiles, ensuring only the owning user can read or write their profile data.
     * @path /users/{userId}
     * @allow (create) - A user can create their own profile if the userId matches their auth.uid.
     * @allow (get, list) - A user can only get or list their own profile if the userId matches their auth.uid.
     * @allow (update, delete) - A user can update or delete their own profile if the userId matches their auth.uid.
     * @deny (create) - A user cannot create a profile for another user.
     * @deny (get, list) - A user cannot get or list the profile of another user.
     * @deny (update, delete) - A user cannot update or delete the profile of another user.
     * @principle Enforces strict user-ownership for user profile data.
     */
    match /users/{userId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
        return isOwner(userId) && existsAfter(/databases/$(database)/documents/users/$(userId));
      }

      allow get: if isSignedIn() && isOwner(userId);
      allow list: if false; // Listing users is not permitted.
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isSignedIn() && isExistingOwner(userId);
      allow delete: if isSignedIn() && isExistingOwner(userId);
    }

    /**
     * @description Manages sales accounts; read access is public, while writes are currently open. TODO: Implement proper authorization.
     * @path /accounts-db/{accountId}
     * @allow (get, list) - Anyone can read account data.
     * @allow (create) - Anyone can create account data (TODO: Restrict).
     * @allow (update) - Anyone can update account data (TODO: Restrict).
     * @allow (delete) - Anyone can delete account data (TODO: Restrict).
     * @principle Provides public read access while write access requires authorization (TODO).
     */
    match /accounts-db/{accountId} {
        allow get, list: if true;
        allow create: if isSignedIn(); // TODO: Add authorization check
        allow update: if isSignedIn(); // TODO: Add authorization check
        allow delete: if isSignedIn(); // TODO: Add authorization check
    }

    /**
     * @description Manages contacts; read access is public, while writes are currently open. TODO: Implement proper authorization.
     * @path /contacts/{contactId}
     * @allow (get, list) - Anyone can read contact data.
     * @allow (create) - Anyone can create contact data (TODO: Restrict).
     * @allow (update) - Anyone can update contact data (TODO: Restrict).
     * @allow (delete) - Anyone can delete contact data (TODO: Restrict).
     * @principle Provides public read access while write access requires authorization (TODO).
     */
    match /contacts/{contactId} {
        allow get, list: if true;
        allow create: if isSignedIn(); // TODO: Add authorization check
        allow update: if isSignedIn(); // TODO: Add authorization check
        allow delete: if isSignedIn(); // TODO: Add authorization check
    }

    /**
     * @description Manages account product notes; read access is public, while writes are currently open. TODO: Implement proper authorization.
     * @path /account-products/{accountProductId}
     * @allow (get, list) - Anyone can read account product note data.
     * @allow (create) - Anyone can create account product note data (TODO: Restrict).
     * @allow (update) - Anyone can update account product note data (TODO: Restrict).
     * @allow (delete) - Anyone can delete account product note data (TODO: Restrict).
     * @principle Provides public read access while write access requires authorization (TODO).
     */
    match /account-products/{accountProductId} {
        allow get, list: if true;
        allow create: if isSignedIn(); // TODO: Add authorization check
        allow update: if isSignedIn(); // TODO: Add authorization check
        allow delete: if isSignedIn(); // TODO: Add authorization check
    }

    /**
     * @description Manages products; read access is public, while writes are currently open. TODO: Implement proper authorization.
     * @path /products/{productId}
     * @allow (get, list) - Anyone can read product data.
     * @allow (create) - Anyone can create product data (TODO: Restrict).
     * @allow (update) - Anyone can update product data (TODO: Restrict).
     * @allow (delete) - Anyone can delete product data (TODO: Restrict).
     * @principle Provides public read access while write access requires authorization (TODO).
     */
    match /products/{productId} {
        allow get, list: if true;
        allow create: if isSignedIn(); // TODO: Add authorization check
        allow update: if isSignedIn(); // TODO: Add authorization check
        allow delete: if isSignedIn(); // TODO: Add authorization check
    }
  }
}