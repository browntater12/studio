/**
 * @fileoverview Firestore Security Rules for the application.
 *
 * Core Philosophy:
 * This ruleset enforces a user-ownership model for user profiles.
 * Accounts, Contacts, Products, AccountProductNotes, and CallNotes are publicly readable but only modifiable by authenticated users.
 *
 * Data Structure:
 * - /users/{userId}: Stores public user profile information, accessible only to the user themselves.
 * - /accounts-db/{accountId}: Stores sales account information.
 * - /contacts/{contactId}: Stores contact information associated with accounts.
 * - /products/{productId}: Stores product catalog information.
 * - /account-products/{accountProductId}: Stores notes about a specific product for an account.
 * - /call-notes/{callNoteId}: Stores notes taken during sales calls related to accounts and contacts.
 *
 * Key Security Decisions:
 * - Users can only read and write their own profile data.
 * - Accounts, Contacts, Products, AccountProductNotes, and CallNotes are publicly readable but only modifiable by authenticated users.
 * - Schema validation is relaxed to allow for rapid prototyping. Only authorization-critical fields are validated.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Controls access to user profile information.
     * @path /users/{userId}
     * @allow (create) User with ID 'user123' can create their own profile.
     *     - auth.uid: 'user123'
     *     - request.resource.data: { id: 'user123', displayName: 'John Doe', email: 'john.doe@example.com' }
     * @allow (get, list, update, delete) User with ID 'user123' can read their own profile.
     *     - auth.uid: 'user123'
     * @deny (create) User with ID 'user123' cannot create another user's profile.
     *     - auth.uid: 'user123'
     *     - request.resource.data: { id: 'user456', displayName: 'Jane Doe', email: 'jane.doe@example.com' }
     * @deny (get, list, update, delete) User with ID 'user123' cannot read or modify another user's profile.
     *     - auth.uid: 'user456'
     * @principle Enforces document ownership for user profiles.
     */
    match /users/{userId} {
      allow get: if isSignedIn() && isOwner(userId);
      allow list: if false;
      allow create: if isSignedIn() && isOwner(userId) && request.resource.data.id == userId;
      allow update: if isSignedIn() && isOwner(userId) && resource.data.id == request.resource.data.id;
      allow delete: if isSignedIn() && isExistingOwner(userId);
    }

    /**
     * @description Controls access to sales account information. Accounts are publicly readable, but only authenticated users can create, update, or delete them.
     * @path /accounts-db/{accountId}
     * @allow (get, list) Any user (signed in or not) can read account information.
     * @allow (create) Signed-in user can create new account.
     *     - auth.uid: 'user123'
     *     - request.resource.data: { name: 'Acme Corp', status: 'lead' }
     * @allow (update, delete) Signed-in user can update or delete an existing account.
     *     - auth.uid: 'user123'
     * @deny (create, update, delete) Unauthenticated user cannot create, update, or delete accounts.
     *     - auth.uid: null
     * @principle Allows public read access with authenticated-user-only writes for accounts.
     */
    match /accounts-db/{accountId} {
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn() && resource != null;
      allow delete: if isSignedIn() && resource != null;
    }

    /**
     * @description Controls access to contact information. Contacts are publicly readable, but only authenticated users can create, update, or delete them.
     * @path /contacts/{contactId}
     * @allow (get, list) Any user (signed in or not) can read contact information.
     * @allow (create) Signed-in user can create new contact.
     *     - auth.uid: 'user123'
     *     - request.resource.data: { accountNumber: 'A123', name: 'John Doe', phone: '555-1234', email: 'john.doe@example.com', location: 'New York', isMainContact: true }
     * @allow (update, delete) Signed-in user can update or delete an existing contact.
     *     - auth.uid: 'user123'
     * @deny (create, update, delete) Unauthenticated user cannot create, update, or delete contacts.
     *     - auth.uid: null
     * @principle Allows public read access with authenticated-user-only writes for contacts.
     */
    match /contacts/{contactId} {
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn() && resource != null;
      allow delete: if isSignedIn() && resource != null;
    }

    /**
     * @description Controls access to product information. Products are publicly readable, but only authenticated users can create, update, or delete them.
     * @path /products/{productId}
     * @allow (get, list) Any user (signed in or not) can read product information.
     * @allow (create) Signed-in user can create new product.
     *     - auth.uid: 'user123'
     *     - request.resource.data: { name: 'Product A', productNumber: 'P123', volumes: ['pails', 'drums'] }
     * @allow (update, delete) Signed-in user can update or delete an existing product.
     *     - auth.uid: 'user123'
     * @deny (create, update, delete) Unauthenticated user cannot create, update, or delete products.
     *     - auth.uid: null
     * @principle Allows public read access with authenticated-user-only writes for products.
     */
    match /products/{productId} {
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn() && resource != null;
      allow delete: if isSignedIn() && resource != null;
    }

    /**
     * @description Controls access to account product notes. Product notes are publicly readable, but only authenticated users can create, update, or delete them.
     * @path /account-products/{accountProductId}
     * @allow (get, list) Any user (signed in or not) can read account product notes.
     * @allow (create) Signed-in user can create new account product note.
     *     - auth.uid: 'user123'
     *     - request.resource.data: { accountId: 'A123', productId: 'P123', notes: 'Some notes' }
     * @allow (update, delete) Signed-in user can update or delete an existing account product note.
     *     - auth.uid: 'user123'
     * @deny (create, update, delete) Unauthenticated user cannot create, update, or delete account product notes.
     *     - auth.uid: null
     * @principle Allows public read access with authenticated-user-only writes for account product notes.
     */
    match /account-products/{accountProductId} {
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn() && resource != null;
      allow delete: if isSignedIn() && resource != null;
    }

    /**
     * @description Controls access to call notes. Call notes are publicly readable, but only authenticated users can create, update, or delete them.
     * @path /call-notes/{callNoteId}
     * @allow (get, list) Any user (signed in or not) can read call notes.
     * @allow (create) Signed-in user can create new call note.
     *     - auth.uid: 'user123'
     *     - request.resource.data: { accountId: 'A123', callDate: '2024-01-01T12:00:00Z', notes: 'Call notes', contactIds: [] }
     * @allow (update, delete) Signed-in user can update or delete an existing call note.
     *     - auth.uid: 'user123'
     * @deny (create, update, delete) Unauthenticated user cannot create, update, or delete call notes.
     *     - auth.uid: null
     * @principle Allows public read access with authenticated-user-only writes for call notes.
     */
    match /call-notes/{callNoteId} {
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn() && resource != null;
      allow delete: if isSignedIn() && resource != null;
    }
  }

  // Helper functions
  function isSignedIn() {
    return request.auth != null;
  }

  function isOwner(userId) {
    return request.auth.uid == userId;
  }

  function isExistingOwner(userId) {
    return isOwner(userId) && resource != null;
  }
}