/**
 * @file Firestore Security Rules
 * @description This ruleset enforces a flexible security model focused on data ownership and access control for sales data.
 *
 * Data Structure:
 * - User profiles are stored under `/users/{userId}`.
 * - Accounts are stored under `/accounts-db/{accountId}`.
 * - Contacts are stored under `/contacts/{contactId}`.
 * - Account Product Notes are stored under `/account-products/{accountProductId}`.
 * - Products are stored under `/products/{productId}`.
 * - Call Notes are stored under `/call-notes/{callNoteId}`.
 *
 * Key Security Decisions:
 * - User profiles are publicly readable, but only the owner can modify their own profile.
 * - Accounts, Contacts, Account Product Notes, Products and Call Notes can be created, updated, and deleted by any authenticated user.
 *
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Controls access to user profile information.
     * @path /users/{userId}
     * @allow (get, list) if true
     * @allow (create, update, delete) if isOwner(userId)
     * @deny (create) if !isOwner(userId)
     * @deny (update, delete) if !isOwner(userId)
     * @principle Enforces user-ownership for profile modifications.
     */
    match /users/{userId} {
      // Allow anyone to read user profiles.
      allow get, list: if true;

      // Allow a user to create their own profile.
      allow create: if isOwner(userId) && request.resource.data.email == request.auth.token.email;

      // Allow a user to update their own profile. Enforce immutability for the user id on updates.
      allow update: if isOwner(userId) && resource.data.email == request.auth.token.email;

      // Allow a user to delete their own profile.
      allow delete: if isOwner(userId);
    }

    /**
     * @description Controls access to accounts.
     * @path /accounts-db/{accountId}
     * @allow (get, list) if true
     * @allow (create, update, delete) if isSignedIn()
     * @deny (create) if !isSignedIn()
     * @deny (update, delete) if !isSignedIn()
     * @principle Allows any authenticated user to manage accounts.
     */
    match /accounts-db/{accountId} {
      // Anyone can read accounts.
      allow get, list: if true;

      // Only authenticated users can create accounts.
      allow create: if isSignedIn();

      // Only authenticated users can update accounts.
      allow update: if isSignedIn();

      // Only authenticated users can delete accounts.
      allow delete: if isSignedIn();
    }

    /**
     * @description Controls access to contacts.
     * @path /contacts/{contactId}
     * @allow (get, list) if true
     * @allow (create, update, delete) if isSignedIn()
     * @deny (create) if !isSignedIn()
     * @deny (update, delete) if !isSignedIn()
     * @principle Allows any authenticated user to manage contacts.
     */
    match /contacts/{contactId} {
      // Anyone can read contacts.
      allow get, list: if true;

      // Only authenticated users can create contacts.
      allow create: if isSignedIn();

      // Only authenticated users can update contacts.
      allow update: if isSignedIn();

      // Only authenticated users can delete contacts.
      allow delete: if isSignedIn();
    }

    /**
     * @description Controls access to account product notes.
     * @path /account-products/{accountProductId}
     * @allow (get, list) if true
     * @allow (create, update, delete) if isSignedIn()
     * @deny (create) if !isSignedIn()
     * @deny (update, delete) if !isSignedIn()
     * @principle Allows any authenticated user to manage account product notes.
     */
    match /account-products/{accountProductId} {
      // Anyone can read account product notes.
      allow get, list: if true;

      // Only authenticated users can create account product notes.
      allow create: if isSignedIn();

      // Only authenticated users can update account product notes.
      allow update: if isSignedIn();

      // Only authenticated users can delete account product notes.
      allow delete: if isSignedIn();
    }

    /**
     * @description Controls access to products.
     * @path /products/{productId}
     * @allow (get, list) if true
     * @allow (create, update, delete) if isSignedIn()
     * @deny (create) if !isSignedIn()
     * @deny (update, delete) if !isSignedIn()
     * @principle Allows any authenticated user to manage products.
     */
    match /products/{productId} {
      // Anyone can read products.
      allow get, list: if true;

      // Only authenticated users can create products.
      allow create: if isSignedIn();

      // Only authenticated users can update products.
      allow update: if isSignedIn();

      // Only authenticated users can delete products.
      allow delete: if isSignedIn();
    }

    /**
     * @description Controls access to call notes.
     * @path /call-notes/{callNoteId}
     * @allow (get, list) if true
     * @allow (create, update, delete) if isSignedIn()
     * @deny (create) if !isSignedIn()
     * @deny (update, delete) if !isSignedIn()
     * @principle Allows any authenticated user to manage call notes.
     */
    match /call-notes/{callNoteId} {
      // Anyone can read call notes.
      allow get, list: if true;

      // Only authenticated users can create call notes.
      allow create: if isSignedIn();

      // Only authenticated users can update call notes.
      allow update: if isSignedIn();

      // Only authenticated users can delete call notes.
      allow delete: if isSignedIn();
    }
  }

  // Helper function to determine if the user is signed in.
  function isSignedIn() {
    return request.auth != null;
  }

  // Helper function to determine if the user is the owner of the resource.
  function isOwner(userId) {
    return request.auth.uid == userId;
  }
}