/**
 * @file Firebase Security Rules for Firestore.
 *
 * @core_philosophy This ruleset prioritizes security by enforcing strict ownership and role-based access control.
 *   It is configured for the prototyping phase. Data validation is relaxed to allow for rapid iteration.
 *
 * @data_structure The Firestore database is structured as follows:
 *   - /users/{userId}: User profile information, accessible only by the user themselves.
 *   - /accounts-db/{accountId}: Sales account information.
 *   - /contacts/{contactId}: Contact information.
 *   - /account-products/{accountProductId}: Product notes, linking accounts to products.
 *   - /products/{productId}: Product catalog.
 *   - /call-notes/{callNoteId}: Call notes linked to accounts.
 *
 * @key_security_decisions
 *   - User listing is disabled to prevent information leakage.
 *   - Accounts and other top-level collections are secured to prevent unauthorized access.
 *   - Data validation is minimal to enable rapid prototyping. More comprehensive validation will be added in later phases.
 *   - get requests are always permitted for non-existent documents to allow the client application to return the appropriate error messages.
 *
 * @denormalization_for_authorization None.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Allows a user to read and write their own profile data.
     * @path /users/{userId}
     * @allow (create) User with UID 'test_user' can create their profile at /users/test_user if request.auth.uid == 'test_user'.
     * @allow (get, update, delete) User with UID 'test_user' can read/update/delete their profile at /users/test_user.
     * @deny (create) User with UID 'another_user' cannot create a profile at /users/test_user.
     * @deny (get, update, delete) User with UID 'another_user' cannot read/update/delete the profile at /users/test_user.
     * @principle Enforces document ownership for user profiles.
     */
    match /users/{userId} {
      function isOwner(userId) {
        return request.auth != null && request.auth.uid == userId;
      }
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId);
      allow update: if isOwner(userId) && resource.data.id == userId;
      allow delete: if isOwner(userId) && resource != null;
    }

    /**
     * @description Allows anyone to read a product.
     * @path /products/{productId}
     * @allow (get, list) Any user, signed in or not, can read product information.
     * @deny (create, update, delete) No one can create, update, or delete products without specific authorization (e.g., admin role).
     * @principle Public read, restricted write.
     */
    match /products/{productId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Allows read and write access to account notes.
     * @path /account-products/{accountProductId}
     * @allow (get, list) Any user, signed in or not, can read account product note information.
     * @deny (create, update, delete) No one can create, update, or delete account product notes without specific authorization (e.g., admin role).
     * @principle Public read, restricted write.
     */
    match /account-products/{accountProductId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Allows read and write access to account data.
     * @path /accounts-db/{accountId}
     * @allow (get, list) Any user, signed in or not, can read account information.
     * @deny (create, update, delete) No one can create, update, or delete accounts without specific authorization (e.g., admin role).
     * @principle Public read, restricted write.
     */
    match /accounts-db/{accountId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Allows read and write access to contact data.
     * @path /contacts/{contactId}
     * @allow (get, list) Any user, signed in or not, can read contact information.
     * @deny (create, update, delete) No one can create, update, or delete contacts without specific authorization (e.g., admin role).
     * @principle Public read, restricted write.
     */
    match /contacts/{contactId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Allows read and write access to call note data.
     * @path /call-notes/{callNoteId}
     * @allow (get, list) Any user, signed in or not, can read call note information.
     * @deny (create, update, delete) No one can create, update, or delete call notes without specific authorization (e.g., admin role).
     * @principle Public read, restricted write.
     */
    match /call-notes/{callNoteId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }
  }
}